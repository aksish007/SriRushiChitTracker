// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  registrationId String   @unique
  email          String?  // Removed @unique to allow multiple NULL values in SQL Server
  password       String
  firstName      String
  lastName       String
  phone          String   @unique
  address        String?
  aadharNumber   String?
  panNumber      String?
  intendedChitValue Decimal?
  role           String   @default("USER") // Changed from UserRole enum
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Referral relationships
  referredBy   String?
  referrer     User?   @relation("UserReferrals", fields: [referredBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referrals    User[]  @relation("UserReferrals")

  // Chit subscriptions
  subscriptions ChitSubscription[]
  
  // Payouts
  payouts       Payout[]
  
  // Audit logs
  auditLogs     AuditLog[]
  
  // Nominee details
  nominees      Nominee[]

  @@map("users")
}

model ChitScheme {
  id          String   @id @default(cuid())
  chitId      String   @unique
  name        String
  amount      Decimal
  duration    Int      // in months
  totalSlots  Int
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions ChitSubscription[]

  @@map("chit_schemes")
}

model ChitSubscription {
  id           String   @id @default(cuid())
  subscriberId String
  userId       String
  chitSchemeId String
  status       String   @default("ACTIVE") // Changed from SubscriptionStatus enum
  joinedAt     DateTime @default(now())
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  chitScheme ChitScheme @relation(fields: [chitSchemeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  payouts    Payout[]

  @@unique([chitSchemeId, subscriberId])
  @@map("chit_subscriptions")
}

model Payout {
  id           String   @id @default(cuid())
  userId       String
  subscriptionId String
  amount       Decimal
  month        Int
  year         Int
  status       String   @default("PENDING") // Changed from PayoutStatus enum
  paidAt       DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User             @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subscription ChitSubscription @relation(fields: [subscriptionId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([subscriptionId, month, year])
  @@map("payouts")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("audit_logs")
}

model Nominee {
  id           String   @id @default(cuid())
  userId       String
  name         String
  relation     String
  age          Int?
  dateOfBirth  DateTime?
  guardian     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("nominees")
}